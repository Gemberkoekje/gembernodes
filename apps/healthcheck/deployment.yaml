apiVersion: apps/v1
kind: Deployment
metadata:
  name: cluster-healthcheck
  namespace: cluster-healthcheck
  labels:
    app: cluster-healthcheck
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cluster-healthcheck
  template:
    metadata:
      labels:
        app: cluster-healthcheck
    spec:
      containers:
        - name: health
          image: caddy:2.10.2-alpine
          command:
            - caddy
          args:
            - run
            - --config
            - /etc/caddy/Caddyfile
          ports:
            - containerPort: 8080
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /live
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 20
          volumeMounts:
            - name: site
              mountPath: /srv
            - name: caddy-config
              mountPath: /etc/caddy
              readOnly: true
      volumes:
        - name: site
          configMap:
            name: cluster-healthcheck-page
            items:
              - key: index.html
                path: index.html
              - key: ready
                path: ready
              - key: live
                path: live
        - name: caddy-config
          configMap:
            name: cluster-healthcheck-page
            items:
              - key: Caddyfile
                path: Caddyfile
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-healthcheck-page
  namespace: cluster-healthcheck
data:
  index.html: |
    <!doctype html>
    <html>
      <head>
        <title>cluster healthy</title>
      </head>
      <body>
        <h1>âœ… All systems nominal</h1>
        <p>{{ .Release.Name }} reports {{ .Values.clusterName }} alive at {{ .Values.timestamp }}</p>
      </body>
    </html>
  ready: |
    ok
  live: |
    ok
  Caddyfile: |
    :8080 {
      handle_path /healthcheck* {
        root * /srv
        try_files {path} /index.html
        file_server
      }

      handle_path /ready* {
        root * /srv
        file_server
      }

      handle_path /live* {
        root * /srv
        file_server
      }

      handle {
        respond "not found" 404
      }
    }